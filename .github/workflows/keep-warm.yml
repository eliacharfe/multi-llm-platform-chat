name: Keep Render Warm

on:
  schedule:
    - cron: "*/3 * * * *"   # every 3 minutes (UTC)
  workflow_dispatch: {}      # allows manual run from GitHub UI

jobs:
  ping:
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: Ping backend warm-db
        env:
          HEALTH_URL: ${{ secrets.HEALTH_URL }}
        run: |
          echo "Pinging: $HEALTH_URL"

          # curl:
          # - retries 3 times
          # - max 15s per attempt
          # - prints status + time
          # - fails if not 200
          curl -sS -L \
            --max-time 15 \
            --retry 3 \
            --retry-delay 3 \
            --retry-connrefused \
            -o /dev/null \
            -w "status=%{http_code} time=%{time_total}s\n" \
            -H "Cache-Control: no-store" \
            "$HEALTH_URL" | tee /tmp/curl_out.txt

          # enforce status 200
          if ! grep -q "status=200" /tmp/curl_out.txt; then
            echo "Health check failed"
            exit 1
          fi