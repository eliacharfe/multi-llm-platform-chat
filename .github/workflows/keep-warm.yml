name: Keep Render Warm

on:
  schedule:
    - cron: "*/4 * * * *"
  workflow_dispatch: {}

jobs:
  warm:
    runs-on: ubuntu-latest
    timeout-minutes: 4

    steps:
      - name: Ping backend health (retry once)
        env:
          HEALTH_URL: ${{ secrets.HEALTH_URL }}
        run: |
          set -e

          echo "Pinging: $HEALTH_URL"
          curl -sS -L --max-time 20 \
            -o /dev/null \
            -w "health status=%{http_code} time=%{time_total}s\n" \
            -H "Cache-Control: no-store" \
            "$HEALTH_URL" \
          || (echo "health failed, retrying in 3s..." && sleep 3 && \
              curl -sS -L --max-time 20 \
                -o /dev/null \
                -w "health (retry) status=%{http_code} time=%{time_total}s\n" \
                -H "Cache-Control: no-store" \
                "$HEALTH_URL")

      - name: Warm DB (retry once)
        env:
          WARM_DB_URL: ${{ secrets.WARM_DB_URL }}
        run: |
          set -e

          echo "Warming DB: $WARM_DB_URL"
          curl -sS -L --max-time 25 \
            -o /dev/null \
            -w "warm-db status=%{http_code} time=%{time_total}s\n" \
            -H "Cache-Control: no-store" \
            "$WARM_DB_URL" \
          || (echo "warm-db failed, retrying in 3s..." && sleep 3 && \
              curl -sS -L --max-time 25 \
                -o /dev/null \
                -w "warm-db (retry) status=%{http_code} time=%{time_total}s\n" \
                -H "Cache-Control: no-store" \
                "$WARM_DB_URL")